@using FITR_DC_FORM.Models

@{
    ViewData["Title"] = "FITR - DC List";
    var role = Context.Session.GetString("UserRole");
    var dcList = ViewBag.DcList as List<FitrMaster>;
}


<style>
    /* ONE deleted row */
    tr.row-deleted {
        background-color: #fff1f1 !important;
        opacity: 0.6;
    }

        tr.row-deleted a,
        tr.row-deleted button,
        tr.row-deleted input {
            pointer-events: none;
            cursor: not-allowed;
        }

    .deleted-badge {
        display: inline-block;
        padding: 3px 8px;
        font-size: 11px;
        font-weight: 600;
        color: #fff;
        background-color: #dc3545;
        border-radius: 4px;
        margin-left: 8px;
    }

    /*   .dataTables_filter {
            float: right !important;
        } */

    #makeinline {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
        flex-wrap: nowrap;
    }
    /* ðŸ”’ LOCK DATATABLE SEARCH WIDTH â€“ PREVENT OVERLAP */
    .dt-search {
        display: flex;
        align-items: center;
    }

        .dt-search input {
            width: 220px !important;
            min-width: 220px;
            max-width: 220px;
        }
    /* Stop Search and Add from overlapping */
    .dt-search {
        margin-right: 120px; /* reserve space for + Add button */
    }

        /* Optional but recommended: lock search width */
        .dt-search input {
            width: 220px;
        }

        .dt-search > label {
            margin-top: 5px;
        }
    /* Decrease row height */
    .product-removes.inbox-data td {
        padding-top: 6px !important;
        padding-bottom: 6px !important;
        line-height: 0.5;
    }

    #grip-click {
        display: none;
    }

    #cog-click {
        display: none;
    }

    tr.row-deleted a:not(.dt-control),
    tr.row-deleted button,
    tr.row-deleted input {
        pointer-events: none;
    }

    /* ðŸ”¥ PLUS ICON ALWAYS CLICKABLE */
    td.dt-control,
    td.dt-control i {
        pointer-events: auto !important;
        cursor: pointer;
    }



    /* TABLE BASE */

    /* TABLE BASE - NATIVE SCROLLING (FINAL FIX) */
    #roles-permission {
        width: auto !important;         /* Let content dictate width */
        min-width: 100% !important;     /* Fill at least the container */
        margin-bottom: 0px !important;
        border-collapse: collapse !important;
        table-layout: auto !important;  /* CRITICAL: Allow columns to expand */
    }

    /* Cell Content */
    #roles-permission th,
    #roles-permission td {
        white-space: nowrap !important; /* Forces expansion */
        padding: 12px 15px !important;
        vertical-align: middle;
        font-size: 13px;
        border-bottom: 1px solid #eee;
        
        /* PREVENT OVERLAP */
        width: auto !important;
        max-width: none !important;
        overflow: visible !important;
        box-sizing: border-box !important;
    }

    /* Header Centering */
    /* Header Centering - REMOVED global center to allow specific alignment */
    #roles-permission th {
        /* text-align: center !important;  <-- REMOVED */
        vertical-align: middle;
        background-color: #fafafa; /* Keep header distinct */
        font-weight: 600;
    }
    
    /* Ensure Container Handles Scroll */
    .table-responsive {
        overflow-x: auto !important;
        width: 100% !important;
        border: 1px solid #f0f0f0;
    }

    /* REMOVED FIXED WIDTH CLASSES to allow natural expansion */
    .col-plus, .col-check {
        width: 40px !important;
        text-align: center;
    }

    /* Action column should have a minimum width to keep buttons together */
    .col-action {
        min-width: 140px !important;
    }
    
    /* Container for horizontal scroll */
    .table-responsive {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        width: 100% !important;
        display: block !important;
    }

    /* Professional Button Grouping */
    .action-btn-group {
        display: flex !important;
        gap: 4px !important;
        justify-content: center !important;
        align-items: center !important;
    }

    .btn-xs {
        padding: 4px 8px !important;
        font-size: 11px !important;
        line-height: 1.2 !important;
        border-radius: 4px !important;
    }

    /* Icons */
    .col-attach i {
        color: #0d6efd;
        font-size: 15px;
        cursor: pointer;
    }

    .dt-control i {
        cursor: pointer;
    }

    #roles-permission_paginate{
        display:flex;
    }

    tr.row-deleted {
        background-color: #fff1f1 !important;
        opacity: 0.6;
    }

    /* Disable everything EXCEPT plus icon */
    tr.row-deleted a:not(.dt-control),
    tr.row-deleted button:not(.soft-delete-btn),
    tr.row-deleted input {
        pointer-events: none;
        cursor: not-allowed;
    }

    /* Delete button disabled look */
    tr.row-deleted .soft-delete-btn {
        opacity: 0.4;
        cursor: not-allowed;
    }

    /* ðŸ¢ PREMIUM COMPANY SELECTION MODAL STYLES */
    #companyModal .modal-content {
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        overflow: hidden;
    }

    #companyModal .modal-header {
        background: #fff;
        border-bottom: 1px solid #f0f0f0;
        padding: 20px 24px;
    }

    #companyModal .modal-title {
        font-weight: 700;
        color: #2c3e50;
        font-size: 1.25rem;
    }

    #companyModal .modal-body {
        padding: 24px;
        background-color: #fbfbfb;
    }

    /* Selection Type Container */
    .company-type-selector {
        display: flex;
        gap: 15px;
        margin-bottom: 24px;
    }

    .selection-card {
        flex: 1;
        cursor: pointer;
        position: relative;
        padding: 16px;
        border: 2px solid #eef2f7;
        border-radius: 12px;
        background: #fff;
        transition: all 0.25s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        text-align: center;
    }

    .selection-card:hover {
        border-color: #7366ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(115, 102, 255, 0.08);
    }

    .selection-card.active {
        border-color: #7366ff;
        background-color: rgba(115, 102, 255, 0.04);
    }

    .selection-card i {
        font-size: 24px;
        color: #acb5bd;
        transition: color 0.25s ease;
    }

    .selection-card.active i {
        color: #7366ff;
    }

    .selection-card .card-label {
        font-weight: 600;
        font-size: 14px;
        color: #495057 !important; /* Ensure visibility */
    }

    .selection-card.active .card-label {
        color: #7366ff !important;
    }

    .selection-card .check-icon {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 18px;
        height: 18px;
        background: #7366ff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 10px;
        opacity: 0;
        transform: scale(0.5);
        transition: all 0.2s ease;
    }

    .selection-card.active .check-icon {
        opacity: 1;
        transform: scale(1);
    }

    .company-info-area {
        background: #fff;
        border-radius: 12px;
        border: 1px solid #f0f0f0;
        padding: 20px;
        animation: fadeIn 0.3s ease-out;
    }

    #companyModal .modal-footer {
        border-top: 1px solid #f0f0f0;
        padding: 16px 24px;
        background: #fff;
    }

    #companyModal .btn-primary {
        background: linear-gradient(135deg, #7366ff 0%, #a178ff 100%);
        border: none;
        padding: 10px 24px;
        font-weight: 600;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(115, 102, 255, 0.25);
    }

    #companyModal .btn-secondary {
        background: #f1f3f5;
        color: #495057;
        border: none;
        padding: 10px 24px;
        font-weight: 600;
        border-radius: 8px;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(5px); }
        to { opacity: 1; transform: translateY(0); }
    }

</style>



<div class="container-fluid mt-4">
    <div class="card-body">
        <div class="container-fluid user-list-wrapper">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header card-no-border">
                            <div id="makeinline" class="d-flex justify-content-between align-items-center w-100">
                                <!-- Left side: Filters -->
                                <div class="d-flex gap-2">
                                    <a asp-action="List"
                                       asp-route-filter="pending"
                                       class="btn btn-sm @(ViewBag.Filter == "pending" ? "btn-primary" : "btn-outline-primary")">
                                        Approval Pending
                                    </a>

                                    <a asp-action="List"
                                       asp-route-filter="all"
                                       class="btn btn-sm @(ViewBag.Filter == "all" ? "btn-primary" : "btn-outline-primary")">
                                        All Data
                                    </a>
                                </div>

                                <!-- Right side: Actions -->
                                <div class="d-flex gap-2 align-items-center">
                                    <a asp-controller="Fitr" asp-action="New" class="btn btn-primary f-w-500">
                                        <i class="fa-solid fa-plus pe-2"></i>Add
                                    </a>
                                    <button type="button" class="btn btn-secondary" id="btnPrint">
                                        <i class="fa fa-print me-1"></i> Print
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body pt-0 px-0">
                            <div class="list-product user-list-table">
                                <div class="table-responsive custom-scrollbar">
                                    <table class="table table-hover align-middle" id="roles-permission">
                                        <thead>
                                            <tr>
                                                <th class="col-plus text-center">#</th>
                                                <th class="col-check text-center">
                                                    <input type="checkbox" id="selectAll" />
                                                </th>
                                                <th class="col-tc text-center">TC No</th>
                                                <th class="col-customer text-start">Customer Name</th>
                                                <th class="col-dc text-center">DC No</th>
                                                <th class="col-product text-start">Product Type</th>
                                                <th class="col-po text-start">Party PO No</th>
                                                <th class="col-model text-start">Model</th>
                                                <th class="col-status text-center">Status</th>
                                                <th class="col-attach text-center">PO</th>
                                                <th class="col-attach text-center">DC</th>
                                                <th class="col-attach text-center">Drawing</th>
                                                <th class="col-attach text-center">TC</th>
                                                <th class="col-action text-center">Actions</th>
                                            </tr>
                                        </thead>

                                        <tbody>
                                            @if (dcList != null && dcList.Any())
                                            {
                                                foreach (var dc in dcList)
                                                {
                                                    <tr class="product-removes inbox-data"
                                                        data-id="@dc.FitrId"
                                                        data-srdata='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(dc.SrData))'>

                                                        <!-- EXPANDER -->
                                                        <td class="dt-control text-center">
                                                            <i class="fa-solid fa-plus-square text-primary" style="font-size:16px;"></i>
                                                        </td>

                                                        <!-- CHECKBOX -->
                                                        <td class="col-check text-center">
                                                            @if ((dc.Status == "Approved" || dc.Status == "FINAL_APPROVED") || (role == "ADMIN" || role == "SUPERADMIN"))
                                                            {
                                                                <input type="checkbox" class="row-check" value="@dc.FitrId" />
                                                            }
                                                            else
                                                            {
                                                                <input type="checkbox" disabled title="Printing allowed only after Final Approval" style="cursor: not-allowed; opacity: 0.5;" />
                                                            }
                                                        </td>

                                                        <td class="col-tc text-center">@dc.TCNo</td>

                                                        <td class="col-customer text-start">@dc.CompanyName</td>

                                                        @* <td class="col-dc text-center">
                                                            <a asp-controller="Fitr"
                                                               asp-action="Index"
                                                               asp-route-id="@dc.FitrId">
                                                                @dc.DCNo
                                                            </a>
                                                        </td> *@
                                                        <td class="col-dc text-center">
                                                            
                                                                @dc.DCNo
                                                            
                                                        </td> 

                                                        <td class="col-product text-start">@dc.ProductType</td>

                                                        <td class="col-po text-start">@dc.PONo</td>

                                                        <td class="col-model text-start">@dc.Model</td>

                                                      @*   <td class="col-status text-center">
                                                            @if (dc.Status == "DRAFT")
                                                            {
                                                                <span class="badge bg-secondary">Draft</span>
                                                            }
                                                            else if (dc.Status == "SUBMITTED")
                                                            {
                                                                <span class="badge bg-warning">Submitted</span>
                                                            }
                                                            else if (dc.Status == "HOD_APPROVED")
                                                            {
                                                                <span class="badge bg-info">HOD Approved</span>
                                                            }
                                                            else if (dc.Status == "FINAL_APPROVED")
                                                            {
                                                                <span class="badge bg-success">Final Approved</span>
                                                            }
                                                        </td> *@
                                                        <td class="col-status text-center">
                                                            @if (dc.Status == "Draft" || dc.Status == "DRAFT")
                                                            {
                                                                <span class="badge bg-secondary">Draft</span>
                                                            }
                                                            else if (dc.Status == "HOD Approval Pending" || dc.Status == "SUBMITTED")
                                                            {
                                                                <span class="badge bg-warning text-dark">HOD Approval Pending</span>
                                                            }
                                                            else if (dc.Status == "Admin Approval Pending" || dc.Status == "HOD_APPROVED")
                                                            {
                                                                <span class="badge bg-info text-white">Admin Approval Pending</span>
                                                            }
                                                            else if (dc.Status == "Approved" || dc.Status == "FINAL_APPROVED")
                                                            {
                                                                <span class="badge bg-success">Approved</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">@dc.Status</span>
                                                            }
                                                        </td>



                                                        <!-- PO -->
                                                        <td class="col-attach text-center">
                                                            @if (!string.IsNullOrEmpty(dc.POAttachmentPath))
                                                            {
                                                                <a href="~/@dc.POAttachmentPath" target="_blank">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            }
                                                            else
                                                            {

                                                                <span>-</span>
                                                            }
                                                        </td>

                                                        <!-- DC -->
                                                        <td class="col-attach text-center">
                                                            @if (!string.IsNullOrEmpty(dc.DCAttachmentPath))
                                                            {
                                                                <a href="~/@dc.DCAttachmentPath" target="_blank">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            }
                                                            else
                                                            {

                                                                <span>-</span>
                                                            }
                                                        </td>

                                                        <!-- DRAWING -->
                                                        <td class="col-attach text-center">
                                                            @if (!string.IsNullOrEmpty(dc.DrawingAttachmentPath))
                                                            {
                                                                <a href="~/@dc.DrawingAttachmentPath" target="_blank">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            }
                                                            else
                                                            {

                                                                <span>-</span>
                                                            }
                                                        </td>

                                                        <!-- TC -->
                                                        <td class="col-attach text-center">
                                                            @if (!string.IsNullOrEmpty(dc.TCAttachmentPath))
                                                            {
                                                                <a href="~/@dc.TCAttachmentPath" target="_blank">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            }
                                                            else
                                                            {

                                                                <span>-</span>
                                                            }
                                                        </td>

                                                        <!-- ACTIONS -->
                                                        <td class="col-action text-center">
                                                            <div class="action-btn-group">
                                                                <!-- âœï¸ EDIT (Only for Drafts - USER or SUPERADMIN) -->
                                                                @if ((role == "USER" || role == "SUPERADMIN") && (dc.Status == "Draft" || dc.Status == "DRAFT" || dc.Status == "PREPARED"))
                                                                {
                                                                    <a asp-action="Index" asp-route-id="@dc.FitrId" class="btn btn-xs btn-info" title="Edit">
                                                                        <i class="fa fa-pencil"></i>
                                                                    </a>
                                                                }

                                                                <!-- ðŸ“¤ SUBMIT (USER) -->
                                                                @if (role == "USER" && (dc.Status == "Draft" || dc.Status == "DRAFT" || dc.Status == "PREPARED"))
                                                                {
                                                                    <form asp-action="Submit" method="post" class="m-0">
                                                                        <input type="hidden" name="id" value="@dc.FitrId" />
                                                                        <button class="btn btn-xs btn-primary" title="Submit" data-confirm="Are you sure you want to submit this entry?">Submit</button>
                                                                    </form>
                                                                }

                                                                <!-- âœ… APPROVE (HOD) -->
                                                                @if (role == "HOD" && (dc.Status == "HOD Approval Pending" || dc.Status == "SUBMITTED"))
                                                                {
                                                                    <form asp-action="ApproveByHod" method="post" class="m-0">
                                                                        <input type="hidden" name="id" value="@dc.FitrId" />
                                                                        <button class="btn btn-xs btn-warning" title="Approve" data-confirm="Are you sure you want to approve this entry?">Approve</button>
                                                                    </form>
                                                                }

                                                                <!-- ðŸ† FINAL APPROVE (ADMIN) -->
                                                                @if (role == "ADMIN" && (dc.Status == "Admin Approval Pending" || dc.Status == "HOD_APPROVED"))
                                                                {
                                                                    <form asp-action="ApproveByAdmin" method="post" class="m-0">
                                                                        <input type="hidden" name="id" value="@dc.FitrId" />
                                                                        <button class="btn btn-xs btn-success" title="Final Approve" data-confirm="Are you sure you want to provide Final Approval?">Final Approve</button>
                                                                    </form>
                                                                }

                                                                <!-- ðŸ–¨ï¸ PRINT Logic -->
                                                                @if (dc.Status == "Approved" || dc.Status == "FINAL_APPROVED")
                                                                {
                                                                    <button type="button" class="btn btn-xs btn-secondary individual-print-btn" data-id="@dc.FitrId" title="Print">
                                                                        <i class="fa fa-print"></i>
                                                                    </button>
                                                                }
                                                                else if (role == "ADMIN" || role == "SUPERADMIN")
                                                                {
                                                                    @* Admins can print even pending entries for checking *@
                                                                    <button type="button" class="btn btn-xs btn-secondary individual-print-btn" data-id="@dc.FitrId" title="Print (Pending Approval)">
                                                                        <i class="fa fa-print"></i>
                                                                    </button>
                                                                }
                                                                else
                                                                {
                                                                    @* Disabled for USER/HOD if not approved *@
                                                                    <button type="button" class="btn btn-xs btn-light disabled" title="Final Approval Required" style="opacity: 0.5; cursor: not-allowed;">
                                                                        <i class="fa fa-print text-muted"></i>
                                                                    </button>
                                                                }

                                                                <!-- ðŸ—‘ï¸ DELETE (SUPERADMIN or USER/Draft) -->
                                                                @if (role == "SUPERADMIN" || (role == "USER" && (dc.Status == "Draft" || dc.Status == "DRAFT")))
                                                                {
                                                                    <button type="button" class="btn btn-xs btn-danger soft-delete-btn" title="Delete">
                                                                        <i class="fa fa-trash"></i>
                                                                    </button>
                                                                }
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="14" class="text-center text-muted">
                                                        No DC records found
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ================= COMPANY SELECTION MODAL ================= -->
<div class="modal fade" id="companyModal" tabindex="-1" aria-labelledby="companyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="companyModalLabel">Select Company for Print</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Choice Cards for Selection Type -->
                <div class="company-type-selector">
                    <div class="selection-card" id="cardSameCompany" data-value="same">
                        <div class="check-icon"><i class="fa fa-check"></i></div>
                        <i class="fa fa-building"></i>
                        <span class="card-label">Same Company</span>
                        <input type="radio" name="companySelectionType" value="same" class="d-none">
                    </div>
                    <div class="selection-card" id="cardOtherCompany" data-value="other">
                        <div class="check-icon"><i class="fa fa-check"></i></div>
                        <i class="fa fa-building-columns"></i>
                        <span class="card-label">Other Company</span>
                        <input type="radio" name="companySelectionType" value="other" class="d-none">
                    </div>
                    <div class="selection-card" id="cardNoCompany" data-value="none">
                        <div class="check-icon"><i class="fa fa-check"></i></div>
                        <i class="fa fa-eye-slash"></i>
                        <span class="card-label">Without Company</span>
                        <input type="radio" name="companySelectionType" value="none" class="d-none">
                    </div>
                </div>

                <!-- WRAPPER FOR DYNAMIC VISIBILITY -->
                <div id="otherCompanyContainer" class="d-none">
                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted small text-uppercase">Choose Printing Entity</label>
                        <select id="selectPrintCompany" class="form-select shadow-none" style="border-radius: 8px; padding: 10px;">
                            <option value="">-- Select Company --</option>
                        </select>
                    </div>
                    <!-- Enhanced Preview Area -->
                    <div id="companyPreview" class="company-info-area d-none">
                        <div class="d-flex align-items-start gap-3">
                            <div id="previewLogoContainer" class="p-2 border bg-white rounded" style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                                <img id="previewLogo" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <h6 id="previewName" class="mb-1 fw-bold text-primary text-truncate"></h6>
                                <p id="previewAddress" class="mb-0 small text-muted" style="line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sameCompanyInfo" class="company-info-area d-none">
                    <div class="d-flex align-items-center gap-3">
                        <div class="p-3 bg-light rounded-circle text-primary" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                            <i class="fa fa-building" style="font-size: 20px;"></i>
                        </div>
                        <div>
                            <p class="mb-0 fw-bold text-dark" id="mainCompanyName">Aira Euro Pvt Ltd</p>
                            <p class="mb-0 small text-muted" id="mainCompanySubtitle">Aira India - Default Selection</p>
                        </div>
                    </div>
                </div>

                <div id="noCompanyInfo" class="company-info-area d-none">
                    <div class="d-flex align-items-center gap-3">
                        <div class="p-3 bg-light rounded-circle text-danger" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                            <i class="fa fa-eye-slash" style="font-size: 20px;"></i>
                        </div>
                        <div>
                            <p class="mb-0 fw-bold text-dark">No Branding</p>
                            <p class="mb-0 small text-muted">Print without Name & Logo</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnConfirmPrint">
                    <i class="fa fa-print me-2"></i> Proceed to Print
                </button>
            </div>
        </div>
    </div>
</div>



@section Scripts {




    <script>
        (function () {

            const STORAGE_KEY = "FITR_DELETED_IDS";
            let table;

            function getDeletedIds() {
                return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
            }

            function saveDeletedIds(ids) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
            }

            function applyDeletedRows() {
                const deletedIds = getDeletedIds();

                $("#roles-permission tbody tr").each(function () {
                    const $row = $(this);
                    const id = String($row.data("id"));

                    $row.removeClass("row-deleted");
                    $row.find(".deleted-badge").remove();

                    if (deletedIds.includes(id)) {
                        $row.addClass("row-deleted");
                        $row.find(".customer-name")
                            .after('<span class="deleted-badge ms-2">DELETED</span>');
                    }
                });
            }

            function formatSrTable(srData) {
                if (!srData || srData.length === 0) {
                    return `<div class="p-2 text-muted">No SR Data</div>`;
                }

                let rows = srData.map(s => `
                    <tr>
                        <td>${s.SrNo ?? '-'}</td>
                        <td>${s.ShaftDia ?? '-'}</td>
                        <td>${s.OutputDrive ?? '-'}</td>
                        <td>${s.ActuatorPCD ?? '-'}</td>
                        <td>${s.ValvePCD ?? '-'}</td>
                        <td>${s.SquareDia ?? '-'}</td>
                        <td>${s.SquarePosition ?? '-'}</td>
                    </tr>
                `).join('');

                return `
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>SrNo</th>
                                <th>Shaft</th>
                                <th>Output</th>
                                <th>Actuator</th>
                                <th>Valve</th>
                                <th>Square</th>
                                <th>Position</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            }

            $(document).ready(function () {

                // âœ… SUPPRESS DATATABLE ERRORS GLOBALLY
                $.fn.dataTable.ext.errMode = 'none'; // Disable error alerts

                // âœ… INIT DATATABLE (ONLY ONCE) - Handle empty tables
                const $table = $("#roles-permission");
                const $tbody = $table.find("tbody");
                const $rows = $tbody.find("tr");
                
                // Check if table has actual data rows (not just empty message)
                const hasData = $rows.length > 0 && !$rows.find("td[colspan]").length;

                try {
                    if (hasData) {
                        table = $table.DataTable({
                            columnDefs: [
                                { targets: [0, 1], orderable: false } // + icon & checkbox
                            ],
                            order: [[2, "desc"]], // TC NO
                            pageLength: 25,
                            lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                            autoWidth: false,
                            // scrollX removed to use native container scrolling
                            language: {
                                emptyTable: "No DC records found",
                                zeroRecords: "No matching records found"
                            }
                        });
                    } else {
                        // For empty tables, initialize with minimal config
                        table = $table.DataTable({
                            columnDefs: [
                                { targets: '_all', orderable: false }
                            ],
                            pageLength: 25,
                            lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                            autoWidth: false,
                            // scrollX removed
                            searching: false,
                            paging: false,
                            info: false,
                            ordering: false,
                            language: {
                                emptyTable: "No DC records found"
                            }
                        });
                    }
                } catch (e) {
                    console.warn('DataTable initialization warning:', e);
                    // Silently fail - table will still be usable without DataTables features
                }

                // âœ… PRINT LOGIC
                let selectedIds = [];
                let printCompanies = [];
                let mainCompany = null;

                // Handle Selection Cards
                $('.selection-card').on('click', function () {
                    const val = $(this).data('value');
                    $('.selection-card').removeClass('active');
                    $(this).addClass('active');
                    $(`input[name="companySelectionType"][value="${val}"]`).prop('checked', true);

                    if (val === 'other') {
                        $('#otherCompanyContainer').removeClass('d-none');
                        $('#sameCompanyInfo').addClass('d-none');
                        $('#noCompanyInfo').addClass('d-none');
                    } else if (val === 'same') {
                        $('#otherCompanyContainer').addClass('d-none');
                        $('#sameCompanyInfo').removeClass('d-none');
                        $('#noCompanyInfo').addClass('d-none');
                    } else if (val === 'none') {
                        $('#otherCompanyContainer').addClass('d-none');
                        $('#sameCompanyInfo').addClass('d-none');
                        $('#noCompanyInfo').removeClass('d-none');
                    }
                });

                $('#btnPrint').on('click', function (e) {
                    e.preventDefault();
                    
                    selectedIds = [];
                    $('.row-check:checked').each(function () {
                        selectedIds.push($(this).val());
                    });

                    if (selectedIds.length === 0) {
                        Swal.fire({
                            title: 'Selection Required',
                            text: 'Please select at least one record to print.',
                            icon: 'warning',
                            confirmButtonColor: '#7366ff'
                        });
                        return;
                    }

                    // NO DEFAULT SELECTION - Explicit choice required
                    $('.selection-card').removeClass('active');
                    $('input[name="companySelectionType"]').prop('checked', false);
                    $('#otherCompanyContainer, #sameCompanyInfo, #noCompanyInfo').addClass('d-none');
                    $('#companyPreview').addClass('d-none');
                    $('#selectPrintCompany').val('');

                    // Load Main Company
                    $.get('/Fitr/GetMainCompany', function (mc) {
                        mainCompany = mc;
                        if (mc) {
                            $('#mainCompanyName').text(mc.companyName);
                            $('#mainCompanySubtitle').text('Default Selection');
                        }
                    });

                    // Load Print companies dynamically
                    $.get('/Fitr/GetPrintCompanies', function (data) {
                        printCompanies = data;
                        const $select = $('#selectPrintCompany');
                        $select.html('<option value="">-- Select Company --</option>');
                        data.forEach(c => {
                            $select.append(`<option value="${c.printCompanyId}" 
                                            data-addr="${c.companyAddress}" 
                                            data-logo="${c.companyLogo}"
                                            data-name="${c.companyName}">${c.companyName}</option>`);
                        });
                        $('#companyModal').modal('show');
                    });
                });

                $('#selectPrintCompany').on('change', function () {
                    const $opt = $(this).find(':selected');
                    const addr = $opt.data('addr');
                    const logo = $opt.data('logo');
                    const name = $opt.data('name');

                    const $preview = $('#companyPreview');

                    if ($opt.val()) {
                        $('#previewName').text(name);
                        $('#previewAddress').html(addr ? addr.replace(/\n/g, '<br/>') : 'No address provided');

                        if (logo) {
                            $('#previewLogo').attr('src', '/uploads/' + logo);
                            $('#previewLogoContainer').show();
                        } else {
                            $('#previewLogo').attr('src', '/assets/images/logo/airaindia-logo.webp');
                        }

                        $preview.removeClass('d-none');
                    } else {
                        $preview.addClass('d-none');
                    }
                });

                $('#btnConfirmPrint').on('click', function () {
                    let companyId = '';
                    let companyName = '';
                    const selectionType = $('input[name="companySelectionType"]:checked').val();

                    if (!selectionType) {
                        Swal.fire({
                            title: 'Selection Required',
                            text: 'Please explicitly choose a printing option.',
                            icon: 'warning',
                            confirmButtonColor: '#7366ff'
                        });
                        return;
                    }

                    if (selectionType === 'same') {
                        // Use Main Company from Company Master
                        companyId = 0; // 0 indicates Main Company fallback in Controller
                        companyName = mainCompany ? mainCompany.companyName : 'Main Company';
                    } else if (selectionType === 'none') {
                        companyId = -1; // -1 indicates No Branding in Controller
                        companyName = 'No Company Branding';
                    } else {
                        companyId = $('#selectPrintCompany').val();
                        companyName = $('#selectPrintCompany option:selected').text();
                        
                        if (!companyId || companyId === "") {
                            Swal.fire({
                                title: 'Required',
                                text: 'Please select a company for printing.',
                                icon: 'warning',
                                confirmButtonColor: '#7366ff'
                            });
                            return;
                        }
                    }

                    // Professional Confirmation using SweetAlert2
                    Swal.fire({
                        title: 'Confirm Printing',
                        text: 'Proceed with generating Test Certificate(s) for ' + companyName + '?',
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#7366ff',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Yes, Print it!',
                        cancelButtonText: 'No, Wait',
                        focusCancel: true,
                        buttonsStyling: false,
                        customClass: {
                            confirmButton: 'btn btn-lg btn-primary me-2',
                            cancelButton: 'btn btn-lg btn-danger',
                            popup: 'animated fadeInDown faster'
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $('#companyModal').modal('hide');
                            
                            if (selectedIds.length === 1) {
                                window.open('/Fitr/Print/' + selectedIds[0] + '?printCompanyId=' + companyId, '_blank');
                            } else {
                                window.open('/Fitr/PrintMultiple?ids=' + selectedIds.join(',') + '&printCompanyId=' + companyId, '_blank');
                            }
                        }
                    });
                });

                // âœ… SELECT ALL
                $('#selectAll').on('change', function () {
                    $('.row-check').prop('checked', this.checked);
                });

                // âœ… APPLY DELETED STATE AFTER DRAW
                table.on("draw", function () {
                    applyDeletedRows();
                });

                // âœ… INDIVIDUAL PRINT
                $('#roles-permission tbody').on('click', '.individual-print-btn', function (e) {
                    e.preventDefault();
                    const id = $(this).data('id');
                    selectedIds = [id]; // Set global selectedIds
                    
                    // Reset modal to fresh state
                    $('.selection-card').removeClass('active');
                    $('input[name="companySelectionType"]').prop('checked', false);
                    $('#otherCompanyContainer, #sameCompanyInfo, #noCompanyInfo').addClass('d-none');
                    $('#companyPreview').addClass('d-none');
                    $('#selectPrintCompany').val('');

                    // Load Main Company
                    $.get('/Fitr/GetMainCompany', function (mc) {
                        mainCompany = mc;
                        if (mc) {
                            $('#mainCompanyName').text(mc.companyName);
                            $('#mainCompanySubtitle').text('Default Selection');
                        }
                    });

                    // Trigger same logic as btnPrint
                    $.get('/Fitr/GetPrintCompanies', function (data) {
                        printCompanies = data;
                        const $select = $('#selectPrintCompany');
                        $select.html('<option value="">-- Select Company --</option>');
                        data.forEach(c => {
                            $select.append(`<option value="${c.printCompanyId}" 
                                            data-addr="${c.companyAddress}" 
                                            data-logo="${c.companyLogo}"
                                            data-name="${c.companyName}">${c.companyName}</option>`);
                        });
                        $('#companyModal').modal('show');
                    });
                });
                
                // Load Main Company on page load to have it ready
                $.get('/Fitr/GetMainCompany', function (mc) {
                    mainCompany = mc;
                });

                // âœ… SOFT DELETE
                $('#roles-permission tbody').on("click", ".soft-delete-btn", function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    if (!confirm("Are you sure you want to mark this record as deleted?")) return;

                    const id = String($(this).closest("tr").data("id"));
                    const ids = getDeletedIds();

                    if (!ids.includes(id)) {
                        ids.push(id);
                        saveDeletedIds(ids);
                    }

                    applyDeletedRows();
                });

                // âœ… SR (+) TOGGLE RESTORED
                $('#roles-permission tbody').on('click', 'td.dt-control', function (e) {
                    e.stopPropagation();
                    let tr = $(this).closest('tr');
                    let row = table.row(tr);

                    if (row.child.isShown()) {
                        row.child.hide();
                        tr.removeClass('shown');
                        $(this).find('i').removeClass('fa-minus-square').addClass('fa-plus-square');
                    } else {
                        let srData = tr.data('srdata');
                        row.child(formatSrTable(srData)).show();
                        tr.addClass('shown');
                        $(this).find('i').removeClass('fa-plus-square').addClass('fa-minus-square');
                    }
                });

            });

        })();
    </script>
}
