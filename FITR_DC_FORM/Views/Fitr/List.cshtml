@using FITR_DC_FORM.Models

@{
    ViewData["Title"] = "FITR - DC List";
    var role = Context.Session.GetString("UserRole");
    var dcList = ViewBag.DcList as List<FitrMaster>;
}


<style>
    /* üèÜ NEW PROFESSIONAL STYLE FOR LIST VIEW */
    :root {
        --primary-gradient: linear-gradient(135deg, #7366ff 0%, #a178ff 100%);
        --success-gradient: linear-gradient(135deg, #51bb25 0%, #75d94c 100%);
        --warning-gradient: linear-gradient(135deg, #f8d62b 0%, #f9e262 100%);
        --info-gradient: linear-gradient(135deg, #167dff 0%, #4ea1ff 100%);
        --danger-gradient: linear-gradient(135deg, #ff3366 0%, #ff6688 100%);
        --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
    }

    /* üóëÔ∏è DELETED ROW STYLING - REFINED */
    tr.row-deleted {
        background-color: #fff5f5 !important;
        opacity: 0.9;
    }

    tr.row-deleted td {
        color: #e74c3c !important;
    }

    /* üìä TABLE ENHANCEMENTS */
    #roles-permission {
        width: 100% !important;
        border-collapse: collapse !important;
        margin-top: 10px !important;
    }

    #roles-permission thead th {
        background-color: #f8f9fa;
        color: #555;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.5px;
        padding: 12px !important; /* Standardized padding */
        border-bottom: 2px solid #eee !important;
    }

    #roles-permission tbody tr {
        background-color: #fff;
        transition: all 0.2s ease;
        border-bottom: 1px solid #f0f0f0;
    }

    #roles-permission tbody tr:hover {
        background-color: #f9f9ff !important;
    }

    #roles-permission td {
        padding: 12px !important;
        vertical-align: middle !important;
        font-size: 13px;
        color: #333;
        line-height: 1.4 !important;
    }

    /* üè∑Ô∏è PREMIUM BADGES */
    .badge {
        padding: 6px 12px !important;
        font-weight: 600 !important;
        font-size: 10px !important;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        border-radius: 30px !important;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .bg-primary { background: var(--primary-gradient) !important; color: white !important; }
    .bg-success { background: var(--success-gradient) !important; color: white !important; }
    .bg-warning { background: var(--warning-gradient) !important; color: #333 !important; }
    .bg-info { background: var(--info-gradient) !important; color: white !important; }
    .bg-danger { background: var(--danger-gradient) !important; color: white !important; }
    .bg-secondary { background: #e9ecef !important; color: #495057 !important; border: 1px solid #dee2e6; }

    /* üõ†Ô∏è ACTION BUTTONS */
    .action-btn-group {
        display: flex;
        gap: 6px;
        justify-content: center;
    }

    .btn-xs {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 !important;
        border-radius: 6px !important;
        transition: all 0.2s;
        border: none;
    }

    .btn-xs:hover {
        transform: scale(1.1);
    }

    .btn-xs i { font-size: 12px; }
    
    /* üíé INDUSTRIAL ACTION BUTTONS */
    .btn-industrial {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 8px 16px !important;
        font-size: 12px !important;
        font-weight: 600 !important;
        border-radius: 8px !important;
        border: none !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
        color: white !important;
        white-space: nowrap;
        height: 36px;
    }

    .btn-industrial:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.15) !important;
        filter: brightness(1.1);
    }

    .btn-industrial:active {
        transform: translateY(0);
    }

    .btn-industrial i {
        font-size: 14px;
    }

    .btn-industrial-primary { background: var(--primary-gradient) !important; }
    .btn-industrial-success { background: var(--success-gradient) !important; }
    .btn-industrial-warning { background: var(--warning-gradient) !important; color: #333 !important; }
    .btn-industrial-info { background: var(--info-gradient) !important; }

    /* üìÅ ATTACHMENT ICONS */
    .col-attach i {
        color: #acb5bd;
        font-size: 16px;
        transition: color 0.2s;
    }

    .col-attach a:hover i {
        color: #7366ff;
    }

    /* ‚ûï EXPANDER ICON */
    .dt-control {
        cursor: pointer;
    }

    .dt-control i {
        transition: transform 0.2s;
    }

    tr.shown td.dt-control i {
        transform: rotate(45deg);
        color: #ff3366 !important;
    }

    /* üîç SEARCH AND FILTERS BAR */
    #makeinline {
        background: #fff;
        padding: 5px 0;
        margin-bottom: 10px;
    }

    .user-list-wrapper .card {
        border: none;
        box-shadow: 0 0 20px rgba(89, 102, 122, 0.05);
        border-radius: 12px;
    }

    .card-header {
        background-color: transparent !important;
        border-bottom: none !important;
        padding: 20px 25px !important;
    }

    /* üè¢ COMPANY MODAL STYLING - REFINED */
    #companyModal .modal-content {
        border-radius: 15px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }

    .company-type-selector {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
    }

    .selection-card {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .selection-card:hover {
        background-color: #f8f9ff;
        border-color: #7366ff;
    }

    .selection-card.active {
        border-color: #7366ff;
        background-color: #f0eeff;
        box-shadow: 0 4px 12px rgba(115,102,255,0.1);
    }

    .selection-card i:not(.check-icon i) {
        font-size: 20px;
        color: #666;
        width: 30px;
        text-align: center;
    }

    .selection-card.active i:not(.check-icon i) {
        color: #7366ff;
    }

    .selection-card .card-label {
        font-weight: 600;
        color: #444;
        flex-grow: 1;
    }

    .selection-card .check-icon {
        color: #7366ff;
        display: none;
        font-size: 14px;
    }

    .selection-card.active .check-icon {
        display: block;
    }

    .company-info-area {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-top: 10px;
        border: 1px dashed #ddd;
    }

    /* üìú CUSTOM SCROLLBAR */
    .table-responsive::-webkit-scrollbar { height: 6px; width: 6px; }
    .table-responsive::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
    .table-responsive::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    .table-responsive::-webkit-scrollbar-thumb:hover { background: #aaa; }

    /* üîò CLEAN CHECKBOX STYLING */
    .form-check-input {
        cursor: pointer;
        width: 1.1em;
        height: 1.1em;
        border: 2px solid #ddd;
        transition: all 0.2s;
    }

    .form-check-input:checked {
        background-color: #7366ff;
        border-color: #7366ff;
    }

</style>



<div class="container-fluid mt-4">
    <div class="card-body">
        <div class="container-fluid user-list-wrapper">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header card-no-border">
                            <div id="makeinline" class="d-flex justify-content-between align-items-center w-100">
                                <!-- Left side: Filters -->
                                <div class="d-flex gap-2">
                                    <a asp-action="List"
                                       asp-route-filter="pending"
                                       class="btn btn-sm @(ViewBag.Filter == "pending" ? "btn-primary" : "btn-outline-primary")">
                                        Approval Pending
                                    </a>

                                    <a asp-action="List"
                                       asp-route-filter="all"
                                       class="btn btn-sm @(ViewBag.Filter == "all" ? "btn-primary" : "btn-outline-primary")">
                                        All Data
                                    </a>
                                </div>

                                <!-- Right side: Actions -->
                                <div class="d-flex gap-2 align-items-center">
                                    <a asp-controller="Fitr" asp-action="New" class="btn btn-primary f-w-500">
                                        <i class="fa-solid fa-plus pe-2"></i>Add
                                    </a>
                                    @if (!(ViewBag.Filter == "pending" && (role == "USER" || role == "HOD")))
                                    {
                                        <button type="button" class="btn btn-secondary" id="btnPrint">
                                            <i class="fa fa-print me-1"></i> Print
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="card-body pt-0 px-0">
                            <div class="list-product user-list-table">
                                <div class="table-responsive custom-scrollbar">
                                    <table class="table table-hover align-middle" id="roles-permission">
                                        <thead>
                                            <tr>
                                                <th class="col-plus text-center">#</th>
                                                <th class="col-check text-center">
                                                    <input type="checkbox" id="selectAll" class="form-check-input" />
                                                </th>
                                                <th class="col-tc text-center">TC No</th>
                                                <th class="col-customer text-start">Customer Name</th>
                                                <th class="col-dc text-center">DC No</th>
                                                <th class="col-product text-start">Product Type</th>
                                                <th class="col-po text-start">Party PO No</th>
                                                <th class="col-model text-start">Model</th>
                                                <th class="col-status text-center">Status</th>
                                                <th class="col-attach text-center">PO</th>
                                                <th class="col-attach text-center">DC</th>
                                                <th class="col-attach text-center">Drawing</th>
                                                <th class="col-attach text-center">TC</th>
                                                <th class="col-action text-center" style="min-width: 140px;">Actions</th>
                                            </tr>
                                        </thead>

                                        <tbody>
                                            @if (dcList != null && dcList.Any())
                                            {
                                                foreach (var dc in dcList)
                                                {
                                                    @* <tr class="product-removes inbox-data" *@
                                                    <tr class="product-removes inbox-data @(dc.IsDeleted ? "row-deleted" : "")"
                                                        data-id="@dc.FitrId"
                                                        data-srdata='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(dc.SrData))'>

                                                        <!-- EXPANDER -->
                                                        <td class="dt-control">
                                                            <i class="fa-solid fa-plus text-primary"></i>
                                                        </td>

                                                        <!-- CHECKBOX (no selection for deleted rows) -->
                                                        <td class="col-check text-center">
                                                            @if (dc.IsDeleted)
                                                            {
                                                                <input type="checkbox" disabled title="This record has been deleted" class="form-check-input" style="cursor: not-allowed; opacity: 0.4;" />
                                                            }
                                                            else if (ViewBag.Filter == "pending" && (role == "USER" || role == "HOD"))
                                                            {
                                                                <input type="checkbox" disabled title="Printing not allowed from Pending view" class="form-check-input" style="cursor: not-allowed; opacity: 0.4;" />
                                                            }
                                                            else if ((dc.Status == "Approved" || dc.Status == "FINAL_APPROVED") || (role == "ADMIN" || role == "SUPERADMIN"))
                                                            {
                                                                <input type="checkbox" class="row-check form-check-input" value="@dc.FitrId" />
                                                            }
                                                            else
                                                            {
                                                                <input type="checkbox" disabled title="Printing allowed only after Final Approval" class="form-check-input" style="cursor: not-allowed; opacity: 0.5;" />
                                                            }
                                                        </td>

                                                        <td class="col-tc text-center">
                                                            @if (dc.IsDeleted)
                                                            {
                                                                <span class="text-muted">@dc.TCNo</span>
                                                            }
                                                            else
                                                            {
                                                                @dc.TCNo
                                                            }
                                                        </td>

                                                        <td class="col-customer text-start">
                                                            @if (dc.IsDeleted)
                                                            {
                                                                <span class="text-muted">@dc.CompanyName</span>
                                                            }
                                                            else
                                                            {
                                                                @dc.CompanyName
                                                            }
                                                        </td>

                                                        <td class="col-dc text-center">
                                                            @if (dc.IsDeleted)
                                                            {
                                                                <span class="text-muted">@dc.DCNo</span>
                                                            }
                                                            else
                                                            {
                                                                @dc.DCNo
                                                            }
                                                        </td> 

                                                        <td class="col-product text-start">
                                                            @if (dc.IsDeleted)
                                                            {
                                                                <span class="text-muted">@dc.ProductType</span>
                                                            }
                                                            else
                                                            {
                                                                @dc.ProductType
                                                            }
                                                        </td>

                                                        <td class="col-po text-start">
                                                            @if (dc.IsDeleted)
                                                            {
                                                                <span class="text-muted">@dc.PONo</span>
                                                            }
                                                            else
                                                            {
                                                                @dc.PONo
                                                            }
                                                        </td>

                                                        <td class="col-model text-start">
                                                            @if (dc.IsDeleted)
                                                            {
                                                                <span class="text-muted">@dc.Model</span>
                                                            }
                                                            else
                                                            {
                                                                @dc.Model
                                                            }
                                                        </td>

                                                      @*   <td class="col-status text-center">
                                                            @if (dc.Status == "DRAFT")
                                                            {
                                                                <span class="badge bg-secondary">Draft</span>
                                                            }
                                                            else if (dc.Status == "SUBMITTED")
                                                            {
                                                                <span class="badge bg-warning">Submitted</span>
                                                            }
                                                            else if (dc.Status == "HOD_APPROVED")
                                                            {
                                                                <span class="badge bg-info">HOD Approved</span>
                                                            }
                                                            else if (dc.Status == "FINAL_APPROVED")
                                                            {
                                                                <span class="badge bg-success">Final Approved</span>
                                                            }
                                                        </td> *@
                                                        <td class="col-status text-center">
                                                            @if (dc.IsDeleted)
                                                            {
                                                                <span class="badge bg-danger" style="text-decoration: none !important;">
                                                                    <i class="fa fa-trash me-1"></i>Deleted
                                                                </span>
                                                            }
                                                            else if (dc.Status == "Draft" || dc.Status == "DRAFT")
                                                            {
                                                                <span class="badge bg-secondary">Draft</span>
                                                            }
                                                            else if (dc.Status == "HOD Approval Pending" || dc.Status == "SUBMITTED")
                                                            {
                                                                <span class="badge bg-warning text-dark">HOD Approval Pending</span>
                                                            }
                                                            else if (dc.Status == "Admin Approval Pending" || dc.Status == "HOD_APPROVED")
                                                            {
                                                                <span class="badge bg-info text-white">Admin Approval Pending</span>
                                                            }
                                                            else if (dc.Status == "Approved" || dc.Status == "FINAL_APPROVED")
                                                            {
                                                                <span class="badge bg-success">Approved</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">@dc.Status</span>
                                                            }
                                                        </td>



                                                        <!-- PO -->
                                                        <td class="col-attach text-center">
                                                            @if (dc.IsDeleted)
                                                            {
                                                                @if (!string.IsNullOrEmpty(dc.POAttachmentPath))
                                                                {
                                                                    <i class="fa fa-eye text-muted" style="opacity: 0.5; cursor: not-allowed;" title="View disabled for deleted records"></i>
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-muted">-</span>
                                                                }
                                                            }
                                                            else if (!string.IsNullOrEmpty(dc.POAttachmentPath))
                                                            {
                                                                <a href="~/@dc.POAttachmentPath" target="_blank" title="View PO Document">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            }
                                                            else
                                                            {
                                                                <span>-</span>
                                                            }
                                                        </td>

                                                        <!-- DC -->
                                                        <td class="col-attach text-center">
                                                            @if (dc.IsDeleted)
                                                            {
                                                                @if (!string.IsNullOrEmpty(dc.DCAttachmentPath))
                                                                {
                                                                    <i class="fa fa-eye text-muted" style="opacity: 0.5; cursor: not-allowed;" title="View disabled for deleted records"></i>
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-muted">-</span>
                                                                }
                                                            }
                                                            else if (!string.IsNullOrEmpty(dc.DCAttachmentPath))
                                                            {
                                                                <a href="~/@dc.DCAttachmentPath" target="_blank" title="View DC Document">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            }
                                                            else
                                                            {
                                                                <span>-</span>
                                                            }
                                                        </td>

                                                        <!-- DRAWING -->
                                                        <td class="col-attach text-center">
                                                            @if (dc.IsDeleted)
                                                            {
                                                                @if (!string.IsNullOrEmpty(dc.DrawingAttachmentPath))
                                                                {
                                                                    <i class="fa fa-eye text-muted" style="opacity: 0.5; cursor: not-allowed;" title="View disabled for deleted records"></i>
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-muted">-</span>
                                                                }
                                                            }
                                                            else if (!string.IsNullOrEmpty(dc.DrawingAttachmentPath))
                                                            {
                                                                <a href="~/@dc.DrawingAttachmentPath" target="_blank" title="View Drawing Document">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            }
                                                            else
                                                            {
                                                                <span>-</span>
                                                            }
                                                        </td>

                                                        <!-- TC -->
                                                        <td class="col-attach text-center">
                                                            @if (dc.IsDeleted)
                                                            {
                                                                @if (!string.IsNullOrEmpty(dc.TCAttachmentPath))
                                                                {
                                                                    <i class="fa fa-eye text-muted" style="opacity: 0.5; cursor: not-allowed;" title="View disabled for deleted records"></i>
                                                                }
                                                                else
                                                                {
                                                                    <span class="text-muted">-</span>
                                                                }
                                                            }
                                                            else if (!string.IsNullOrEmpty(dc.TCAttachmentPath))
                                                            {
                                                                <a href="~/@dc.TCAttachmentPath" target="_blank" title="View TC Document">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            }
                                                            else
                                                            {
                                                                <span>-</span>
                                                            }
                                                        </td>

                                                        <!-- ACTIONS -->
                                                        <td class="col-action text-center">
                                                            <div class="action-btn-group">
                                                                <!-- ‚úèÔ∏è EDIT (Only for Drafts - USER or SUPERADMIN) -->
                                                                @if (!dc.IsDeleted && (role == "USER" || role == "SUPERADMIN") && (dc.Status == "Draft" || dc.Status == "DRAFT" || dc.Status == "PREPARED"))
                                                                {
                                                                    <a asp-action="Index" asp-route-id="@dc.FitrId" class="btn btn-xs btn-info" title="Edit">
                                                                        <i class="fa fa-pencil"></i>
                                                                    </a>
                                                                }

                                                                <!-- üì§ SUBMIT (USER) -->
                                                                @if (!dc.IsDeleted && role == "USER" && (dc.Status == "Draft" || dc.Status == "DRAFT" || dc.Status == "PREPARED"))
                                                                {
                                                                    <form asp-action="Submit" method="post" class="d-inline-block m-0">
                                                                        <input type="hidden" name="id" value="@dc.FitrId" />
                                                                        <button class="btn btn-industrial btn-industrial-primary" title="Submit" data-confirm="Are you sure you want to submit this entry?">
                                                                            <i class="fa fa-paper-plane"></i> Submit
                                                                        </button>
                                                                    </form>
                                                                }
                                                                <!-- ‚úÖ APPROVE (HOD) -->
                                                                @if (!dc.IsDeleted && role == "HOD" && (dc.Status == "HOD Approval Pending" || dc.Status == "SUBMITTED"))
                                                                {
                                                                    <form asp-action="ApproveByHod" method="post" class="d-inline-block m-0">
                                                                        <input type="hidden" name="id" value="@dc.FitrId" />
                                                                        <button class="btn btn-industrial btn-industrial-warning" title="Approve" data-confirm="Are you sure you want to approve this entry?">
                                                                            <i class="fa fa-check-double"></i> Approve
                                                                        </button>
                                                                    </form>
                                                                }
                                                                <!-- üèÜ FINAL APPROVE (ADMIN) -->
                                                                @if (!dc.IsDeleted && role == "ADMIN" && (dc.Status == "Admin Approval Pending" || dc.Status == "HOD_APPROVED"))
                                                                {
                                                                    <form asp-action="ApproveByAdmin" method="post" class="d-inline-block m-0">
                                                                        <input type="hidden" name="id" value="@dc.FitrId" />
                                                                        <button class="btn btn-industrial btn-industrial-success" title="Final Approve" data-confirm="Are you sure you want to provide Final Approval?">
                                                                            <i class="fa fa-award"></i> Final Approve
                                                                        </button>
                                                                    </form>
                                                                }
                                                                <!-- üñ®Ô∏è PRINT Logic -->
                                                                @if (!dc.IsDeleted && !(ViewBag.Filter == "pending" && (role == "USER" || role == "HOD")))
                                                                {
                                                                    @if (dc.Status == "Approved" || dc.Status == "FINAL_APPROVED")
                                                                    {
                                                                        <button type="button" class="btn btn-xs btn-secondary individual-print-btn" data-id="@dc.FitrId" title="Print">
                                                                            <i class="fa fa-print"></i>
                                                                        </button>
                                                                    }
                                                                    else if (role == "ADMIN" || role == "SUPERADMIN")
                                                                    {
                                                                        <button type="button" class="btn btn-xs btn-secondary individual-print-btn" data-id="@dc.FitrId" title="Print (Pending Approval)">
                                                                            <i class="fa fa-print"></i>
                                                                        </button>
                                                                    }
                                                                }

                                                                <!-- üóëÔ∏è DELETE (SUPERADMIN, ADMIN or USER/Draft) -->
                                                                @if (!dc.IsDeleted && (role == "SUPERADMIN" || role == "ADMIN" || (role == "USER" && (dc.Status == "Draft" || dc.Status == "DRAFT"))))
                                                                {
                                                                    <button type="button" class="btn btn-xs btn-danger soft-delete-btn" title="Delete">
                                                                        <i class="fa fa-trash"></i>
                                                                    </button>
                                                                }

                                                                @* Show "Deleted" indicator in actions column for deleted records *@
                                                                @if (dc.IsDeleted)
                                                                {
                                                                    <span class="text-muted small" style="text-decoration: none !important; font-style: italic;">
                                                                        <i class="fa fa-ban me-1"></i>Deleted
                                                                    </span>
                                                                }
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="14" class="text-center text-muted">
                                                        No DC records found
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ================= COMPANY SELECTION MODAL ================= -->
<div class="modal fade" id="companyModal" tabindex="-1" aria-labelledby="companyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="companyModalLabel">Select Company for Print</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Choice Cards for Selection Type -->
                <div class="company-type-selector">
                    <div class="selection-card" id="cardSameCompany" data-value="same">
                        <div class="check-icon"><i class="fa fa-check"></i></div>
                        <i class="fa fa-building"></i>
                        <span class="card-label">Same Company</span>
                        <input type="radio" name="companySelectionType" value="same" class="d-none">
                    </div>
                    <div class="selection-card" id="cardOtherCompany" data-value="other">
                        <div class="check-icon"><i class="fa fa-check"></i></div>
                        <i class="fa fa-building-columns"></i>
                        <span class="card-label">Other Company</span>
                        <input type="radio" name="companySelectionType" value="other" class="d-none">
                    </div>
                    <div class="selection-card" id="cardNoCompany" data-value="none">
                        <div class="check-icon"><i class="fa fa-check"></i></div>
                        <i class="fa fa-eye-slash"></i>
                        <span class="card-label">Without Company</span>
                        <input type="radio" name="companySelectionType" value="none" class="d-none">
                    </div>
                </div>

                <!-- WRAPPER FOR DYNAMIC VISIBILITY -->
                <div id="otherCompanyContainer" class="d-none">
                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted small text-uppercase">Choose Printing Entity</label>
                        <select id="selectPrintCompany" class="form-select shadow-none" style="border-radius: 8px; padding: 10px;">
                            <option value="">-- Select Company --</option>
                        </select>
                    </div>
                    <!-- Enhanced Preview Area -->
                    <div id="companyPreview" class="company-info-area d-none">
                        <div class="d-flex align-items-start gap-3">
                            <div id="previewLogoContainer" class="p-2 border bg-white rounded" style="width: 70px; height: 70px; display: flex; align-items: center; justify-content: center;">
                                <img id="previewLogo" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <h6 id="previewName" class="mb-1 fw-bold text-primary text-truncate"></h6>
                                <p id="previewAddress" class="mb-0 small text-muted" style="line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="sameCompanyInfo" class="company-info-area d-none">
                    <div class="d-flex align-items-center gap-3">
                        <div class="p-3 bg-light rounded-circle text-primary" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                            <i class="fa fa-building" style="font-size: 20px;"></i>
                        </div>
                        <div>
                            <p class="mb-0 fw-bold text-dark" id="mainCompanyName">Aira Euro Pvt Ltd</p>
                            <p class="mb-0 small text-muted" id="mainCompanySubtitle">Aira India - Default Selection</p>
                        </div>
                    </div>
                </div>

                <div id="noCompanyInfo" class="company-info-area d-none">
                    <div class="d-flex align-items-center gap-3">
                        <div class="p-3 bg-light rounded-circle text-danger" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                            <i class="fa fa-eye-slash" style="font-size: 20px;"></i>
                        </div>
                        <div>
                            <p class="mb-0 fw-bold text-dark">No Branding</p>
                            <p class="mb-0 small text-muted">Print without Name & Logo</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnConfirmPrint">
                    <i class="fa fa-print me-2"></i> Proceed to Print
                </button>
            </div>
        </div>
    </div>
</div>



@section Scripts {




    <script>
        (function () {
            let table;

            function formatSrTable(srData) {
                if (!srData || srData.length === 0) {
                    return `<div class="p-3 text-center text-muted card shadow-sm m-2">
                                <i class="fa fa-info-circle me-2"></i>No SR Data available for this record
                            </div>`;
                }
                let rows = srData.map(s => `
                    <tr>
                        <td class="text-center fw-bold">${s.SrNo ?? '-'}</td>
                        <td>${s.ShaftDia ?? '-'}</td>
                        <td>${s.OutputDrive ?? '-'}</td>
                        <td>${s.ActuatorPCD ?? '-'}</td>
                        <td>${s.ValvePCD ?? '-'}</td>
                        <td>${s.SquareDia ?? '-'}</td>
                        <td>${s.SquarePosition ?? '-'}</td>
                    </tr>
                `).join('');

                return `
                    <div class="p-3 bg-light rounded shadow-inner m-2">
                        <h6 class="mb-3 text-primary fw-bold"><i class="fa fa-list-check me-2"></i>SR Data Details</h6>
                        <table class="table table-sm table-hover bg-white rounded overflow-hidden shadow-sm mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-center">Sr. No.</th>
                                    <th>Shaft Dia</th>
                                    <th>Output Drive</th>
                                    <th>Actuator PCD</th>
                                    <th>Valve PCD</th>
                                    <th>Square Dia</th>
                                    <th>Position</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
            }

            $(document).ready(function () {
                $.fn.dataTable.ext.errMode = 'none';
                const $table = $("#roles-permission");
                const hasData = $table.find("tbody tr").length > 0 && !$table.find("tbody tr td[colspan]").length;

                try {
                    table = $table.DataTable({
                        columnDefs: [{ targets: [0, 1], orderable: false }],
                        order: [[2, "desc"]],
                        pageLength: 25,
                        lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                        autoWidth: false,
                        language: { emptyTable: "No DC records found", zeroRecords: "No matching records found" }
                    });
                } catch (e) {
                    console.warn('DataTable initialization warning:', e);
                }

                let selectedIds = [];
                let printCompanies = [];
                let mainCompany = null;

                $('.selection-card').on('click', function () {
                    const val = $(this).data('value');
                    $('.selection-card').removeClass('active');
                    $(this).addClass('active');
                    $(`input[name="companySelectionType"][value="${val}"]`).prop('checked', true);
                    $('#otherCompanyContainer').toggleClass('d-none', val !== 'other');
                    $('#sameCompanyInfo').toggleClass('d-none', val !== 'same');
                    $('#noCompanyInfo').toggleClass('d-none', val !== 'none');
                });

                $('#btnPrint').on('click', function (e) {
                    e.preventDefault();
                    selectedIds = $('.row-check:checked').map(function () { return $(this).val(); }).get();
                    if (selectedIds.length === 0) {
                        Swal.fire({ title: 'Selection Required', text: 'Please select at least one record.', icon: 'warning', confirmButtonColor: '#7366ff' });
                        return;
                    }
                    openPrintModal();
                });

                function openPrintModal() {
                    $('.selection-card').removeClass('active');
                    $('input[name="companySelectionType"]').prop('checked', false);
                    $('#otherCompanyContainer, #sameCompanyInfo, #noCompanyInfo, #companyPreview').addClass('d-none');
                    $('#selectPrintCompany').val('');

                    $.get('/Fitr/GetMainCompany', function (mc) {
                        mainCompany = mc;
                        if (mc) { $('#mainCompanyName').text(mc.companyName); }
                    });

                    $.get('/Fitr/GetPrintCompanies', function (data) {
                        printCompanies = data;
                        const $select = $('#selectPrintCompany');
                        $select.html('<option value="">-- Select Company --</option>');
                        data.forEach(c => {
                            $select.append(`<option value="${c.printCompanyId}" data-addr="${c.companyAddress}" data-logo="${c.companyLogo}" data-name="${c.companyName}">${c.companyName}</option>`);
                        });
                        $('#companyModal').modal('show');
                    });
                }

                $('#selectPrintCompany').on('change', function () {
                    const $opt = $(this).find(':selected');
                    const $preview = $('#companyPreview');
                    if ($opt.val()) {
                        $('#previewName').text($opt.data('name'));
                        $('#previewAddress').html($opt.data('addr') ? $opt.data('addr').replace(/\n/g, '<br/>') : 'No address');
                        $('#previewLogo').attr('src', $opt.data('logo') ? '/uploads/' + $opt.data('logo') : '/assets/images/logo/airaindia-logo.webp');
                        $preview.removeClass('d-none');
                    } else { $preview.addClass('d-none'); }
                });

                $('#btnConfirmPrint').on('click', function () {
                    const type = $('input[name="companySelectionType"]:checked').val();
                    if (!type) { Swal.fire({ title: 'Required', text: 'Please choose an option.', icon: 'warning' }); return; }
                    
                    let companyId = type === 'same' ? 0 : (type === 'none' ? -1 : $('#selectPrintCompany').val());
                    if (type === 'other' && (!companyId || companyId === "")) { Swal.fire({ title: 'Required', text: 'Select a company.', icon: 'warning' }); return; }

                    $('#companyModal').modal('hide');
                    const url = selectedIds.length === 1 ? '/Fitr/Print/' + selectedIds[0] : '/Fitr/PrintMultiple?ids=' + selectedIds.join(',');
                    window.open(url + (url.includes('?') ? '&' : '?') + 'printCompanyId=' + companyId, '_blank');
                });

                $('#selectAll').on('change', function () { $('.row-check').prop('checked', this.checked); });

                $('#roles-permission tbody').on('click', '.individual-print-btn', function (e) {
                    e.preventDefault();
                    selectedIds = [$(this).data('id')];
                    openPrintModal();
                });

                $('#roles-permission tbody').on("click", ".soft-delete-btn", function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const $tr = $(this).closest("tr");
                    const id = $tr.data("id");
                    const name = $tr.find(".col-customer").text().trim();

                    Swal.fire({
                        title: 'Are you sure?',
                        text: `Delete "${name}"?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'Yes, Delete it!'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            $.post('/Fitr/SoftDelete', { id: id }, function (res) {
                                if (res.success) {
                                    Swal.fire({ title: 'Deleted!', icon: 'success', timer: 1500, showConfirmButton: false })
                                        .then(() => window.location.reload());
                                } else { Swal.fire('Error', res.message, 'error'); }
                            });
                        }
                    });
                });

                $('#roles-permission tbody').on('click', 'td.dt-control', function (e) {
                    e.stopPropagation();
                    let tr = $(this).closest('tr'), row = table.row(tr);
                    if (row.child.isShown()) {
                        row.child.hide();
                        tr.removeClass('shown');
                    } else {
                        row.child(formatSrTable(tr.data('srdata'))).show();
                        tr.addClass('shown');
                    }
                });

                $.get('/Fitr/GetMainCompany', function (mc) { mainCompany = mc; });
            });
        })();
    </script>
}
