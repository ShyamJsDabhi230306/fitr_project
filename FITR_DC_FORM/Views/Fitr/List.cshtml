@using FITR_DC_FORM.Models

@{
    ViewData["Title"] = "FITR - DC List";
    var role = Context.Session.GetString("UserRole");
    var dcList = ViewBag.DcList as List<FitrMaster>;
}


<style>
    /* ONE deleted row */
    tr.row-deleted {
        background-color: #fff1f1 !important;
        opacity: 0.6;
    }

        tr.row-deleted a,
        tr.row-deleted button,
        tr.row-deleted input {
            pointer-events: none;
            cursor: not-allowed;
        }

    .deleted-badge {
        display: inline-block;
        padding: 3px 8px;
        font-size: 11px;
        font-weight: 600;
        color: #fff;
        background-color: #dc3545;
        border-radius: 4px;
        margin-left: 8px;
    }

    /*   .dataTables_filter {
            float: right !important;
        } */

    #makeinline {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
        flex-wrap: nowrap;
    }
    /* 🔒 LOCK DATATABLE SEARCH WIDTH – PREVENT OVERLAP */
    .dt-search {
        display: flex;
        align-items: center;
    }

        .dt-search input {
            width: 220px !important;
            min-width: 220px;
            max-width: 220px;
        }
    /* Stop Search and Add from overlapping */
    .dt-search {
        margin-right: 120px; /* reserve space for + Add button */
    }

        /* Optional but recommended: lock search width */
        .dt-search input {
            width: 220px;
        }

        .dt-search > label {
            margin-top: 5px;
        }
    /* Decrease row height */
    .product-removes.inbox-data td {
        padding-top: 6px !important;
        padding-bottom: 6px !important;
        line-height: 0.5;
    }

    #grip-click {
        display: none;
    }

    #cog-click {
        display: none;
    }

    tr.row-deleted a:not(.dt-control),
    tr.row-deleted button,
    tr.row-deleted input {
        pointer-events: none;
    }

    /* 🔥 PLUS ICON ALWAYS CLICKABLE */
    td.dt-control,
    td.dt-control i {
        pointer-events: auto !important;
        cursor: pointer;
    }



    /* TABLE BASE */

    #roles-permission {
        table-layout: fixed;
        width: 100%;
    }

        #roles-permission th,
        #roles-permission td {
            font-size: 13px;
            vertical-align: middle;
            padding: 10px 8px;
        }

    /* Column widths */
    .col-plus {
        width: 40px;
    }

    .col-check {
        width: 40px;
    }

    .col-tc {
        width: 70px;
    }

    .col-dc {
        width: 90px;
    }

    .col-product {
        width: 150px;
    }

    .col-po {
        width: 120px;
    }

    .col-model {
        width: 100px;
    }

    .col-status {
        width: 120px;
    }

    .col-attach {
        width: 70px;
    }

    .col-action {
        width: 180px !important;
        min-width: 180px !important;
    }

    /* No wrap */
    .col-product,
    .col-model,
    .col-po,
    .col-status,
    .col-action {
        white-space: nowrap !important;
    }

    /* Professional Button Grouping */
    .action-btn-group {
        display: flex !important;
        gap: 4px !important;
        justify-content: center !important;
        align-items: center !important;
    }

    .btn-xs {
        padding: 4px 8px !important;
        font-size: 11px !important;
        line-height: 1.2 !important;
        border-radius: 4px !important;
    }

    /* Icons */
    .col-attach i {
        color: #0d6efd;
        font-size: 15px;
        cursor: pointer;
    }

    .dt-control i {
        cursor: pointer;
    }

    #roles-permission_paginate{
        display:flex;
    }

    tr.row-deleted {
        background-color: #fff1f1 !important;
        opacity: 0.6;
    }

        /* Disable everything EXCEPT plus icon */
        tr.row-deleted a:not(.dt-control),
        tr.row-deleted button:not(.soft-delete-btn),
        tr.row-deleted input {
            pointer-events: none;
            cursor: not-allowed;
        }

        /* Delete button disabled look */
        tr.row-deleted .soft-delete-btn {
            opacity: 0.4;
            cursor: not-allowed;
        }

</style>



<div class="container-fluid mt-4">
    <div class="card-body">
        <div class="container-fluid user-list-wrapper">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header card-no-border">
                            <div id="makeinline" class="d-flex justify-content-between align-items-center w-100">
                                <!-- Left side: Filters -->
                                <div class="d-flex gap-2">
                                    <a asp-action="List"
                                       asp-route-filter="pending"
                                       class="btn btn-sm @(ViewBag.Filter == "pending" ? "btn-primary" : "btn-outline-primary")">
                                        Approval Pending
                                    </a>

                                    <a asp-action="List"
                                       asp-route-filter="all"
                                       class="btn btn-sm @(ViewBag.Filter == "all" ? "btn-primary" : "btn-outline-primary")">
                                        All Data
                                    </a>
                                </div>

                                <!-- Right side: Actions -->
                                <div class="d-flex gap-2 align-items-center">
                                    <a asp-controller="Fitr" asp-action="New" class="btn btn-primary f-w-500">
                                        <i class="fa-solid fa-plus pe-2"></i>Add
                                    </a>
                                    <button type="button" class="btn btn-secondary" id="btnPrint">
                                        <i class="fa fa-print me-1"></i> Print
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body pt-0 px-0">
                            <div class="list-product user-list-table">
                                <div class="table-responsive custom-scrollbar">
                                    <table class="table table-hover align-middle" id="roles-permission">
                                        <thead>
                                            <tr>
                                                <th class="col-plus">#</th>
                                                <th class="col-check text-center">
                                                    <input type="checkbox" id="selectAll" />
                                                </th>
                                                <th class="col-tc">TC No</th>
                                                <th class="col-customer">Customer Name</th>
                                                <th class="col-dc">DC No</th>
                                                <th class="col-product">Product Type</th>
                                                <th class="col-po">Party PO No</th>
                                                <th class="col-model">Model</th>
                                                <th class="col-status text-center">Status</th>
                                                <th class="col-attach text-center">PO</th>
                                                <th class="col-attach text-center">DC</th>
                                                <th class="col-attach text-center">Drawing</th>
                                                <th class="col-attach text-center">TC</th>
                                                <th class="col-action text-center">Actions</th>
                                            </tr>
                                        </thead>

                                        <tbody>
                                            @if (dcList != null && dcList.Any())
                                            {
                                                foreach (var dc in dcList)
                                                {
                                                    <tr class="product-removes inbox-data"
                                                        data-id="@dc.FitrId"
                                                        data-srdata='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(dc.SrData))'>

                                                        <!-- EXPANDER -->
                                                        <td class="dt-control text-center">
                                                            <i class="fa-solid fa-plus-square text-primary" style="font-size:16px;"></i>
                                                        </td>

                                                        <!-- CHECKBOX -->
                                                        <td class="col-check text-center">
                                                            <input type="checkbox" class="row-check" value="@dc.FitrId" />
                                                        </td>

                                                        <td class="col-tc text-center">@dc.TCNo</td>

                                                        <td class="col-customer">@dc.CompanyName</td>

                                                        <td class="col-dc">
                                                            <a asp-controller="Fitr"
                                                               asp-action="Index"
                                                               asp-route-id="@dc.FitrId">
                                                                @dc.DCNo
                                                            </a>
                                                        </td>

                                                        <td class="col-product">@dc.ProductType</td>

                                                        <td class="col-po">@dc.PONo</td>

                                                        <td class="col-model">@dc.Model</td>

                                                      @*   <td class="col-status text-center">
                                                            @if (dc.Status == "DRAFT")
                                                            {
                                                                <span class="badge bg-secondary">Draft</span>
                                                            }
                                                            else if (dc.Status == "SUBMITTED")
                                                            {
                                                                <span class="badge bg-warning">Submitted</span>
                                                            }
                                                            else if (dc.Status == "HOD_APPROVED")
                                                            {
                                                                <span class="badge bg-info">HOD Approved</span>
                                                            }
                                                            else if (dc.Status == "FINAL_APPROVED")
                                                            {
                                                                <span class="badge bg-success">Final Approved</span>
                                                            }
                                                        </td> *@
                                                        <td class="col-status text-center">
                                                            @if (dc.Status == "HOD Approval Pending" || dc.Status == "SUBMITTED")
                                                            {
                                                                <span class="badge bg-warning">HOD Approval Pending</span>
                                                            }
                                                            else if (dc.Status == "Admin Approval Pending" || dc.Status == "HOD_APPROVED")
                                                            {
                                                                <span class="badge bg-info">Admin Approval Pending</span>
                                                            }
                                                            else if (dc.Status == "Approval Pending")
                                                            {
                                                                <span class="badge bg-primary">Approval Pending</span>
                                                            }
                                                            else if (dc.Status == "Approved" || dc.Status == "FINAL_APPROVED")
                                                            {
                                                                <span class="badge bg-success">Approved</span>
                                                            }
                                                            else if (dc.Status == "Draft" || dc.Status == "PREPARED" || dc.Status == "DRAFT")
                                                            {
                                                                <span class="badge bg-secondary">Draft</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-light text-dark">@dc.Status</span>
                                                            }
                                                        </td>



                                                        <!-- PO -->
                                                        <td class="col-attach text-center">
                                                            @if (!string.IsNullOrEmpty(dc.POAttachmentPath))
                                                            {
                                                                <a href="~/@dc.POAttachmentPath" target="_blank">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            }
                                                            else
                                                            {

                                                                <span>-</span>
                                                            }
                                                        </td>

                                                        <!-- DC -->
                                                        <td class="col-attach text-center">
                                                            @if (!string.IsNullOrEmpty(dc.DCAttachmentPath))
                                                            {
                                                                <a href="~/@dc.DCAttachmentPath" target="_blank">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            }
                                                            else
                                                            {

                                                                <span>-</span>
                                                            }
                                                        </td>

                                                        <!-- DRAWING -->
                                                        <td class="col-attach text-center">
                                                            @if (!string.IsNullOrEmpty(dc.DrawingAttachmentPath))
                                                            {
                                                                <a href="~/@dc.DrawingAttachmentPath" target="_blank">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            }
                                                            else
                                                            {

                                                                <span>-</span>
                                                            }
                                                        </td>

                                                        <!-- TC -->
                                                        <td class="col-attach text-center">
                                                            @if (!string.IsNullOrEmpty(dc.TCAttachmentPath))
                                                            {
                                                                <a href="~/@dc.TCAttachmentPath" target="_blank">
                                                                    <i class="fa fa-eye"></i>
                                                                </a>
                                                            }
                                                            else
                                                            {

                                                                <span>-</span>
                                                            }
                                                        </td>

                                                        <!-- ACTIONS -->
                                                        <td class="col-action text-center">
                                                            <div class="action-btn-group">
                                                                <!-- ✏️ EDIT (Only for Drafts - USER or SUPERADMIN) -->
                                                                @if ((role == "USER" || role == "SUPERADMIN") && (dc.Status == "Draft" || dc.Status == "DRAFT" || dc.Status == "PREPARED"))
                                                                {
                                                                    <a asp-action="Index" asp-route-id="@dc.FitrId" class="btn btn-xs btn-info" title="Edit">
                                                                        <i class="fa fa-pencil"></i>
                                                                    </a>
                                                                }

                                                                <!-- 📤 SUBMIT (USER) -->
                                                                @if (role == "USER" && (dc.Status == "Draft" || dc.Status == "DRAFT" || dc.Status == "PREPARED"))
                                                                {
                                                                    <form asp-action="Submit" method="post" class="m-0">
                                                                        <input type="hidden" name="id" value="@dc.FitrId" />
                                                                        <button class="btn btn-xs btn-primary" title="Submit">Submit</button>
                                                                    </form>
                                                                }

                                                                <!-- ✅ APPROVE (HOD) -->
                                                                @if (role == "HOD" && (dc.Status == "HOD Approval Pending" || dc.Status == "SUBMITTED"))
                                                                {
                                                                    <form asp-action="ApproveByHod" method="post" class="m-0">
                                                                        <input type="hidden" name="id" value="@dc.FitrId" />
                                                                        <button class="btn btn-xs btn-warning" title="Approve">Approve</button>
                                                                    </form>
                                                                }

                                                                <!-- 🏆 FINAL APPROVE (ADMIN) -->
                                                                @if (role == "ADMIN" && (dc.Status == "Admin Approval Pending" || dc.Status == "HOD_APPROVED"))
                                                                {
                                                                    <form asp-action="ApproveByAdmin" method="post" class="m-0">
                                                                        <input type="hidden" name="id" value="@dc.FitrId" />
                                                                        <button class="btn btn-xs btn-success" title="Final Approve">Final Approve</button>
                                                                    </form>
                                                                }

                                                                <!-- 👑 SUPERADMIN (All actions) -->
                                                                @if (role == "SUPERADMIN")
                                                                {
                                                                    @if (dc.Status == "HOD Approval Pending" || dc.Status == "SUBMITTED")
                                                                    {
                                                                        <form asp-action="ApproveByHod" method="post" class="m-0">
                                                                            <input type="hidden" name="id" value="@dc.FitrId" />
                                                                            <button class="btn btn-xs btn-warning" title="Approve">Approve</button>
                                                                        </form>
                                                                    }
                                                                    @if (dc.Status == "Admin Approval Pending" || dc.Status == "HOD_APPROVED")
                                                                    {
                                                                        <form asp-action="ApproveByAdmin" method="post" class="m-0">
                                                                            <input type="hidden" name="id" value="@dc.FitrId" />
                                                                            <button class="btn btn-xs btn-success" title="Final Approve">Final Approve</button>
                                                                        </form>
                                                                    }
                                                                }

                                                                <!-- 🖨️ PRINT (For Approved only) -->
                                                                @if (dc.Status == "Approved" || dc.Status == "FINAL_APPROVED")
                                                                {
                                                                    <button type="button" class="btn btn-xs btn-secondary individual-print-btn" data-id="@dc.FitrId" title="Print">
                                                                        <i class="fa fa-print"></i>
                                                                    </button>
                                                                }

                                                                <!-- 🗑️ DELETE (SUPERADMIN or USER/Draft) -->
                                                                @if (role == "SUPERADMIN" || (role == "USER" && (dc.Status == "Draft" || dc.Status == "DRAFT")))
                                                                {
                                                                    <button type="button" class="btn btn-xs btn-danger soft-delete-btn" title="Delete">
                                                                        <i class="fa fa-trash"></i>
                                                                    </button>
                                                                }
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="14" class="text-center text-muted">
                                                        No DC records found
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- ================= COMPANY SELECTION MODAL ================= -->
<div class="modal fade" id="companyModal" tabindex="-1" aria-labelledby="companyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="companyModalLabel">Select Company for Print</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Choose Company</label>
                    <select id="selectPrintCompany" class="form-select">
                        <option value="">-- Select Company --</option>
                    </select>
                </div>
                <!-- Enhanced Preview Area -->
                <div id="companyPreview" class="p-3 border rounded bg-light d-none">
                    <div class="d-flex align-items-start gap-3">
                        <div id="previewLogoContainer" class="p-2 border bg-white rounded" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                            <img id="previewLogo" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
                        </div>
                        <div>
                            <h6 id="previewName" class="mb-1 fw-bold text-primary"></h6>
                            <p id="previewAddress" class="mb-0 small text-muted" style="line-height: 1.4;"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="btnConfirmPrint">Proceed to Print</button>
            </div>
        </div>
    </div>
</div>



@section Scripts {




    <script>
        (function () {

            const STORAGE_KEY = "FITR_DELETED_IDS";
            let table;

            function getDeletedIds() {
                return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
            }

            function saveDeletedIds(ids) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(ids));
            }

            function applyDeletedRows() {
                const deletedIds = getDeletedIds();

                $("#roles-permission tbody tr").each(function () {
                    const $row = $(this);
                    const id = String($row.data("id"));

                    $row.removeClass("row-deleted");
                    $row.find(".deleted-badge").remove();

                    if (deletedIds.includes(id)) {
                        $row.addClass("row-deleted");
                        $row.find(".customer-name")
                            .after('<span class="deleted-badge ms-2">DELETED</span>');
                    }
                });
            }

            function formatSrTable(srData) {
                if (!srData || srData.length === 0) {
                    return `<div class="p-2 text-muted">No SR Data</div>`;
                }

                let rows = srData.map(s => `
                    <tr>
                        <td>${s.SrNo ?? '-'}</td>
                        <td>${s.ShaftDia ?? '-'}</td>
                        <td>${s.OutputDrive ?? '-'}</td>
                        <td>${s.ActuatorPCD ?? '-'}</td>
                        <td>${s.ValvePCD ?? '-'}</td>
                        <td>${s.SquareDia ?? '-'}</td>
                        <td>${s.SquarePosition ?? '-'}</td>
                    </tr>
                `).join('');

                return `
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>SrNo</th>
                                <th>Shaft</th>
                                <th>Output</th>
                                <th>Actuator</th>
                                <th>Valve</th>
                                <th>Square</th>
                                <th>Position</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                `;
            }

            $(document).ready(function () {

                // ✅ INIT DATATABLE (ONLY ONCE)
                table = $("#roles-permission").DataTable({
                    columnDefs: [
                        { targets: [0, 1], orderable: false } // + icon & checkbox
                    ],
                    order: [[2, "desc"]], // TC NO
                    pageLength: 20,
                    autoWidth: false
                });

                // ✅ PRINT LOGIC
                let selectedIds = [];

                $('#btnPrint').on('click', function (e) {
                    e.preventDefault();
                    
                    selectedIds = [];
                    $('.row-check:checked').each(function () {
                        selectedIds.push($(this).val());
                    });

                    if (selectedIds.length === 0) {
                        alert("Please select at least one record to print.");
                        return;
                    }

                    // Load companies dynamically
                    $.get('/Fitr/GetPrintCompanies', function (data) {
                        const $select = $('#selectPrintCompany');
                        $select.html('<option value="">-- Select Company --</option>');
                        data.forEach(c => {
                            $select.append(`<option value="${c.printCompanyId}" 
                                            data-addr="${c.companyAddress}" 
                                            data-logo="${c.companyLogo}"
                                            data-name="${c.companyName}">${c.companyName}</option>`);
                        });
                        $('#companyModal').modal('show');
                    });
                });

                $('#selectPrintCompany').on('change', function () {
                    const $opt = $(this).find(':selected');
                    const addr = $opt.data('addr');
                    const logo = $opt.data('logo');
                    const name = $opt.data('name');

                    const $preview = $('#companyPreview');

                    if ($opt.val()) {
                        $('#previewName').text(name);
                        $('#previewAddress').html(addr ? addr.replace(/\n/g, '<br/>') : 'No address provided');

                        if (logo) {
                            $('#previewLogo').attr('src', '/uploads/' + logo);
                            $('#previewLogoContainer').show();
                        } else {
                            $('#previewLogo').attr('src', '/assets/images/logo/airaindia-logo.webp');
                        }

                        $preview.removeClass('d-none');
                    } else {
                        $preview.addClass('d-none');
                    }
                });

                $('#btnConfirmPrint').on('click', function () {
                    var companyId = $('#selectPrintCompany').val();
                    var companyName = $('#selectPrintCompany option:selected').text();
                    
                    if (!companyId || companyId === "") {
                        alert("Please select a company.");
                        return;
                    }

                    // Professional Confirmation using SweetAlert2
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            title: 'Confirm Printing',
                            text: 'Proceed with generating Test Certificate(s) for ' + companyName + '?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Yes, Print it!',
                            cancelButtonText: 'No, Wait'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $('#companyModal').modal('hide');
                                
                                if (selectedIds.length === 1) {
                                    window.open('/Fitr/Print/' + selectedIds[0] + '?printCompanyId=' + companyId, '_blank');
                                } else {
                                    window.open('/Fitr/PrintMultiple?ids=' + selectedIds.join(',') + '&printCompanyId=' + companyId, '_blank');
                                }
                            }
                        });
                    } else {
                        // Fallback if Swal is not loaded
                        if (confirm('Proceed with generating Test Certificate(s) for ' + companyName + '?')) {
                            $('#companyModal').modal('hide');
                            if (selectedIds.length === 1) {
                                window.open('/Fitr/Print/' + selectedIds[0] + '?printCompanyId=' + companyId, '_blank');
                            } else {
                                window.open('/Fitr/PrintMultiple?ids=' + selectedIds.join(',') + '&printCompanyId=' + companyId, '_blank');
                            }
                        }
                    }
                });

                // ✅ SELECT ALL
                $('#selectAll').on('change', function () {
                    $('.row-check').prop('checked', this.checked);
                });

                // ✅ APPLY DELETED STATE AFTER DRAW
                table.on("draw", function () {
                    applyDeletedRows();
                });

                // ✅ INDIVIDUAL PRINT
                $('#roles-permission tbody').on('click', '.individual-print-btn', function (e) {
                    e.preventDefault();
                    const id = $(this).data('id');
                    selectedIds = [id]; // Set global selectedIds
                    
                    // Trigger same logic as btnPrint
                    $.get('/Fitr/GetPrintCompanies', function (data) {
                        const $select = $('#selectPrintCompany');
                        $select.html('<option value="">-- Select Company --</option>');
                        data.forEach(c => {
                            $select.append(`<option value="${c.printCompanyId}" 
                                            data-addr="${c.companyAddress}" 
                                            data-logo="${c.companyLogo}"
                                            data-name="${c.companyName}">${c.companyName}</option>`);
                        });
                        $('#companyModal').modal('show');
                    });
                });

                // ✅ SOFT DELETE
                $('#roles-permission tbody').on("click", ".soft-delete-btn", function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    if (!confirm("Are you sure you want to mark this record as deleted?")) return;

                    const id = String($(this).closest("tr").data("id"));
                    const ids = getDeletedIds();

                    if (!ids.includes(id)) {
                        ids.push(id);
                        saveDeletedIds(ids);
                    }

                    applyDeletedRows();
                });

                // ✅ SR (+) TOGGLE RESTORED
                $('#roles-permission tbody').on('click', 'td.dt-control', function (e) {
                    e.stopPropagation();
                    let tr = $(this).closest('tr');
                    let row = table.row(tr);

                    if (row.child.isShown()) {
                        row.child.hide();
                        tr.removeClass('shown');
                        $(this).find('i').removeClass('fa-minus-square').addClass('fa-plus-square');
                    } else {
                        let srData = tr.data('srdata');
                        row.child(formatSrTable(srData)).show();
                        tr.addClass('shown');
                        $(this).find('i').removeClass('fa-plus-square').addClass('fa-minus-square');
                    }
                });

            });

        })();
    </script>
}
